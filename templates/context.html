{% extends "base.html" %}
{% block content %}
<section id="context-section">
  <h1>üß† –ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≥–µ–Ω—Ç–æ–≤</h1>
  <div id="context-content" class="sp-context-block">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...</p>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const container = document.getElementById("context-content");

  // —É—Ç–∏–ª–∏—Ç–∞: –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º HTML –∏–∑ last_result.html –≤ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç (Markdown-–ø–æ–¥–æ–±–Ω—ã–π)
  const htmlToMarkdown = (html) => {
    const doc = new DOMParser().parseFromString(html, "text/html");
    return doc.body.innerText
      .replace(/\n{3,}/g, "\n\n")
      .trim();
  };

  try {
    const res = await fetch("/api/context");
    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: " + res.status);
    const data = await res.json();

    let html = "";
    for (const [agent, ctx] of Object.entries(data)) {
      const task = ctx.last_task || "‚Äî";
      const htmlResult = ctx.last_result?.html || "";
      const textResult = htmlResult ? htmlToMarkdown(htmlResult) : "*(–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)*";
      const count = ctx.interaction_count ?? 0;
      const updated = ctx._updated ? new Date(ctx._updated).toLocaleString() : "‚Äî";

      const md = `
### –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–¥–∞—á–∞
${task}

### –†–µ–∑—É–ª—å—Ç–∞—Ç
${textResult}

---

**–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π:** ${count}  
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** ${updated}
      `;

      html += `
      <section class="context-entry">
        <h3 class="agent-name">ü§ñ ${agent}</h3>
        <div class="context-markdown">
          ${marked.parse(md)}
        </div>
      </section>`;
    }

    container.innerHTML = html;
  } catch (err) {
    container.innerHTML = `<p style="color:#c00;">‚ö†Ô∏è ${err.message}</p>`;
  }
});
</script>

{% endblock %}
