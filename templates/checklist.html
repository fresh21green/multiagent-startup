<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>üß© Multiagent System ‚Äî Checklist</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body { padding: 20px; background: #fafafa; font-family: system-ui, sans-serif; }
    h1 { font-size: 22px; margin-bottom: 15px; }
    section { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    button { margin: 5px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; background: #f9f9f9; }
    button:hover { background: #eef; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 6px; max-height: 300px; overflow: auto; }
    input, textarea { border: 1px solid #ccc; border-radius: 5px; padding: 5px; }
    #brainProgress {
      background: linear-gradient(90deg, #2196F3, #4CAF50);
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>üß† Multiagent System ‚Äî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç</h1>

  <section>
    <h3>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (root –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç)</h3>
    <button onclick="checkRoot()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞–ø–∫—É root –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</button>
    <pre id="rootOut"></pre>
  </section>

  <section>
    <h3>üßæ –ü–æ—Ä—É—á–∏—Ç—å –∑–∞–¥–∞—á—É –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h3>
    <textarea id="taskAll" rows="3" cols="60" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –≤—Å–µ—Ö..."></textarea><br>
    <button onclick="assignAll()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤—Å–µ–º</button>
    <pre id="taskOut"></pre>
  </section>

  <section>
    <h3>üß† –ú–æ–∑–≥–æ–≤–æ–π —à—Ç—É—Ä–º (–∂–∏–≤–æ–π —Ä–µ–∂–∏–º)</h3>
    <input id="topic" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É..." style="width:70%;">
    <button onclick="runBrainstorm()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —à—Ç—É—Ä–º</button>
    
    <div id="brainProgress" style="margin-top:10px; height:8px; width:0%; background:#007bff; border-radius:5px; transition:width 0.4s;"></div>
    
    <pre id="brainOut" style="margin-top:15px; white-space:pre-wrap;"></pre>
  </section>

  <section>
    <h3>‚úâÔ∏è –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
    <input id="fromSlug" placeholder="–æ—Ç –∫–æ–≥–æ (slug)" style="width:20%;">
    <input id="toSlug" placeholder="–∫–æ–º—É (slug)" style="width:20%;">
    <input id="msg" placeholder="—Å–æ–æ–±—â–µ–Ω–∏–µ" style="width:40%;">
    <button onclick="delegate()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <pre id="delegOut"></pre>
  </section>

  <section>
    <h3>üìÇ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –æ—Ñ–∏—Å</h3>
    <button onclick="window.open('/office','_blank')">–û—Ç–∫—Ä—ã—Ç—å /office</button>
  </section>

  <section>
    <h3>üß† –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏ –∞–≥–µ–Ω—Ç–æ–≤</h3>
    <button onclick="checkMemory()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å memory.json</button>
    <pre id="memoryOut"></pre>
  </section>

  <section>
    <h3>üß© –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h3>
    <button onclick="window.open('/','_blank')">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</button>
  </section>

<script>
async function checkRoot(){
  const r = await fetch('/folder/root');
  if(!r.ok){
    document.getElementById('rootOut').textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞–ø–∫–∏ root";
    return;
  }
  const j = await r.json();
  const assistant = j.find(a => a.slug === 'assistant_default');
  document.getElementById('rootOut').textContent = assistant
    ? "‚úÖ –ü–∞–ø–∫–∞ root –Ω–∞–π–¥–µ–Ω–∞. –°–æ—Ç—Ä—É–¥–Ω–∏–∫: " + assistant.name
    : "‚ö†Ô∏è –ü–∞–ø–∫–∞ root –µ—Å—Ç—å, –Ω–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
}

async function assignAll(){
  const task = document.getElementById('taskAll').value.trim();
  if(!task) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É!');
  const fd = new FormData();
  fd.append('task', task);
  const res = await fetch('/assign_task_all', { method:'POST', body: fd });
  const json = await res.json();
  document.getElementById('taskOut').textContent = json.ok
    ? JSON.stringify(json.results, null, 2)
    : "‚ùå –û—à–∏–±–∫–∞: " + (json.detail || json.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
}

async function runBrainstorm(){
  const topic = document.getElementById('topic').value.trim();
  if(!topic) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É!');
  
  const output = document.getElementById('brainOut');
  const progress = document.getElementById('brainProgress');
  output.textContent = '';
  progress.style.width = '0%';

  // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–∑–≥–æ–≤–æ–π —à—Ç—É—Ä–º (–ø–æ—à–∞–≥–æ–≤–æ)
  const fd = new FormData();
  fd.append('topic', topic);
  const res = await fetch('/brainstorm', { method:'POST', body: fd });
  const json = await res.json();

  if(!json.ok){
    output.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (json.detail || json.error);
    return;
  }

  const discussion = json.discussion;
  const total = discussion.length || 1;

  for (let i = 0; i < discussion.length; i++) {
    const d = discussion[i];
    progress.style.width = `${((i+1)/total)*100}%`;

    output.textContent += `üë§ ${d.agent}:\n${d.response}\n\n`;
    await new Promise(r => setTimeout(r, 600)); // –Ω–µ–º–Ω–æ–≥–æ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "—Ä–∞–∑–≥–æ–≤–æ—Ä–∞"
  }

  if(json.summary){
    progress.style.width = '100%';
    output.textContent += "----------------------------------\n";
    output.textContent += "üß© –ò—Ç–æ–≥–æ–≤–æ–µ –º–Ω–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:\n" + json.summary;
  }

  // –ß–µ—Ä–µ–∑ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ —Å–±—Ä–æ—Å–∏—Ç—å –ø–æ–ª–æ—Å—É
  setTimeout(() => progress.style.width = '0%', 3000);
}

async function delegate(){
  const from = document.getElementById('fromSlug').value.trim();
  const to = document.getElementById('toSlug').value.trim();
  const msg = document.getElementById('msg').value.trim();
  if(!from || !to || !msg) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
  const fd = new FormData();
  fd.append('from_slug', from);
  fd.append('to_slug', to);
  fd.append('message', msg);
  const res = await fetch('/delegate_task', { method:'POST', body: fd });
  const json = await res.json();
  document.getElementById('delegOut').textContent = JSON.stringify(json, null, 2);
}

async function checkMemory(){
  const out = document.getElementById('memoryOut');
  out.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
  try {
    const res = await fetch('/check_memory');
    const json = await res.json();
    if(!json.ok){
      out.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (json.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
      return;
    }

    // –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    out.innerHTML = '';
    const memories = json.memories;

    for (const agent in memories){
      const section = document.createElement('div');
      section.style.marginBottom = '15px';
      const title = document.createElement('h4');
      title.textContent = `ü§ñ ${agent}`;
      section.appendChild(title);

      const mem = memories[agent];
      if (typeof mem === 'string'){
        section.innerHTML += `<p>‚ö†Ô∏è ${mem}</p>`;
      } else if (!mem.length){
        section.innerHTML += `<p>(–ø–∞–º—è—Ç—å –ø—É—Å—Ç–∞)</p>`;
      } else {
        mem.forEach((m, i) => {
          const block = document.createElement('div');
          block.style.margin = '8px 0';
          block.style.padding = '6px 10px';
          block.style.background = '#f8f8f8';
          block.style.borderRadius = '6px';
          block.style.fontSize = '14px';
          block.innerHTML = `
            <b>#${i+1}</b> ${m.task || '(–Ω–µ—Ç –∑–∞–¥–∞—á–∏)'}<br>
            ${m.result ? `üß© <i>${m.result.slice(0,100)}...</i><br>` : ''}
            ${m.context_sent ? `‚úÇÔ∏è <b>context_sent:</b> ${m.context_sent.slice(0,100)}...<br>` : ''}
          `;
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è full_context
          if (m.full_context) {
            const btn = document.createElement('button');
            btn.textContent = 'üìú –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç';
            btn.style.marginTop = '5px';
            btn.style.padding = '3px 8px';
            btn.style.fontSize = '13px';
            btn.style.border = '1px solid #ccc';
            btn.style.borderRadius = '4px';
            btn.style.cursor = 'pointer';
            btn.style.background = '#fff';

            const fullText = document.createElement('pre');
            fullText.textContent = m.full_context;
            fullText.style.display = 'none';
            fullText.style.whiteSpace = 'pre-wrap';
            fullText.style.background = '#f0f0f0';
            fullText.style.padding = '8px';
            fullText.style.borderRadius = '6px';
            fullText.style.marginTop = '5px';

            btn.addEventListener('click', () => {
              const visible = fullText.style.display === 'block';
              fullText.style.display = visible ? 'none' : 'block';
              btn.textContent = visible ? 'üìú –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç' : 'üîΩ –°–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç';
            });

            block.appendChild(btn);
            block.appendChild(fullText);
          }
          section.appendChild(block);
        });
      }
      out.appendChild(section);
    }
  } catch(e){
    out.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e;
  }
}

</script>
</body>
</html>
