<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Виртуальный офис</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://unpkg.com/force-graph"></script>
  <style>#graph{width:100%;height:600px;background:#fff;border-radius:8px}</style>
</head>
<body>
  <h1>Виртуальный офис</h1>
  <p><a href="/">← Назад</a></p>
  <div id="graph"></div>
  <script>
    const agents = {{ agents | tojson }};
    const nodes = agents.filter(a => !a.is_folder).map(a => ({ id: a.slug, name: a.name, group: a.folder || "root" }));
    const have  = new Set(nodes.map(n => n.id));
    const links = agents.filter(a => !a.is_folder).flatMap(a =>
      (a.connections || []).filter(c => have.has(c)).map(c => ({ source: a.slug, target: c }))
    );
    ForceGraph()(document.getElementById('graph'))
      .graphData({ nodes, links })
      .nodeLabel(n => n.name + " (" + n.group + ")")
      .nodeAutoColorBy('group')
      .onNodeClick(n => window.location.href = `/agent/${n.id}`);
  </script>
</body>
</html>
